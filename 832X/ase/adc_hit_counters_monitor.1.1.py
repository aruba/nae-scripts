# -*- coding: utf-8 -*-
#
# (c) Copyright 2018 Hewlett Packard Enterprise Development LP
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.

Manifest = {
    'Name': 'adc_hit_counters_monitor',
    'Description': 'Network Analytics Agent Script to monitor'
                   'ADC hit counters',
    'Version': '1.1',
    'Author': 'Aruba Networks'
}

ParameterDefinitions = {
    'office365_traffic_bound': {
        'Name': 'office365_traffic_bound',
        'Description': 'Traffic flow to/from Office 365, '
                       'paramater options: \'to\' or \'from\', default is \'to\'',
        'Type': 'String',
        'Default': 'to'
    }
}

IPv4Addresses = ['13.64.0.0/255.224.0.0',
                 '13.96.0.0/255.248.0.0',
                 '13.104.0.0/255.252.0.0',
                 '20.36.0.0/255.252.0.0',
                 '20.128.0.0/255.255.0.0',
                 '20.140.0.0/255.254.0.0',
                 '20.144.0.0/255.252.0.0',
                 '20.160.0.0/255.240.0.0',
                 '20.176.0.0/255.252.0.0',
                 '20.180.0.0/255.252.0.0',
                 '20.184.0.0/255.248.0.0',
                 '23.96.0.0/255.248.0.0',
                 '40.64.0.0/255.192.0.0',
                 '42.159.0.0/255.255.0.0',
                 '51.4.0.0/255.254.0.0',
                 '51.8.0.0/255.255.0.0',
                 '51.10.0.0/255.254.0.0',
                 '51.12.0.0/255.254.0.0',
                 '51.18.0.0/255.255.0.0',
                 '51.51.0.0/255.255.0.0',
                 '51.53.0.0/255.255.0.0',
                 '51.103.0.0/255.255.0.0',
                 '51.104.0.0/255.254.0.0',
                 '51.107.0.0/255.255.0.0',
                 '51.116.0.0/255.255.0.0',
                 '51.120.0.0/255.255.0.0',
                 '51.124.0.0/255.255.0.0',
                 '51.132.0.0/255.255.0.0',
                 '51.136.0.0/255.254.0.0',
                 '51.138.0.0/255.255.0.0',
                 '51.140.0.0/255.252.0.0',
                 '51.144.0.0/255.254.0.0',
                 '52.96.0.0/255.240.0.0',
                 '52.112.0.0/255.252.0.0',
                 '52.120.0.0/255.252.0.0',
                 '52.125.0.0/255.255.0.0',
                 '52.126.0.0/255.254.0.0',
                 '52.130.0.0/255.254.0.0',
                 '52.132.0.0/255.252.0.0',
                 '52.136.0.0/255.248.0.0',
                 '52.145.0.0/255.255.0.0',
                 '52.146.0.0/255.254.0.0',
                 '52.148.0.0/255.252.0.0',
                 '52.152.0.0/255.248.0.0',
                 '52.160.0.0/255.224.0.0',
                 '52.224.0.0/255.224.0.0',
                 '64.4.0.0/255.255.192.0',
                 '65.52.0.0/255.252.0.0',
                 '66.119.144.0/255.255.240.0',
                 '70.37.0.0/255.255.128.0',
                 '70.37.128.0/255.255.192.0',
                 '91.190.216.0/255.255.248.0',
                 '94.245.64.0/255.255.192.0',
                 '103.9.8.0/255.255.252.0',
                 '103.25.156.0/255.255.255.0',
                 '103.25.157.0/255.255.255.0',
                 '103.25.158.0/255.255.254.0',
                 '103.36.96.0/255.255.252.0',
                 '103.255.140.0/255.255.252.0',
                 '104.40.0.0/255.248.0.0',
                 '104.146.0.0/255.254.0.0',
                 '104.208.0.0/255.248.0.0',
                 '111.221.16.0/255.255.240.0',
                 '111.221.64.0/255.255.192.0',
                 '129.75.0.0/255.255.0.0',
                 '131.253.1.0/255.255.255.0',
                 '131.253.3.0/255.255.255.0',
                 '131.253.5.0/255.255.255.0',
                 '131.253.6.0/255.255.255.0',
                 '131.253.8.0/255.255.255.0',
                 '131.253.12.0/255.255.252.0',
                 '131.253.16.0/255.255.254.0',
                 '131.253.18.0/255.255.255.0',
                 '131.253.21.0/255.255.255.0',
                 '131.253.22.0/255.255.254.0',
                 '131.253.24.0/255.255.248.0',
                 '131.253.32.0/255.255.240.0',
                 '131.253.61.0/255.255.255.0',
                 '131.253.62.0/255.255.254.0',
                 '131.253.64.0/255.255.192.0',
                 '131.253.113.128/255.255.255.128',
                 '131.253.115.128/255.255.255.128',
                 '131.253.128.0/255.255.128.0',
                 '132.245.0.0/255.255.0.0',
                 '134.170.0.0/255.255.0.0',
                 '134.177.0.0/255.255.0.0',
                 '137.116.0.0/255.254.0.0',
                 '137.135.0.0/255.255.0.0',
                 '138.91.0.0/255.255.0.0',
                 '138.196.0.0/255.255.0.0',
                 '139.217.0.0/255.255.0.0',
                 '139.219.0.0/255.255.0.0',
                 '141.251.0.0/255.255.0.0',
                 '146.147.0.0/255.255.0.0',
                 '147.243.0.0/255.255.0.0',
                 '150.171.0.0/255.255.0.0',
                 '150.171.40.0/255.255.252.0',
                 '150.242.48.0/255.255.252.0',
                 '157.54.0.0/255.254.0.0',
                 '157.56.0.0/255.252.0.0',
                 '157.60.0.0/255.255.0.0',
                 '167.220.0.0/255.255.0.0',
                 '168.61.0.0/255.255.0.0',
                 '168.62.0.0/255.254.0.0',
                 '191.232.0.0/255.248.0.0',
                 '192.32.0.0/255.255.0.0',
                 '192.48.225.0/255.255.255.0',
                 '192.84.159.0/255.255.255.0',
                 '192.84.160.0/255.255.254.0',
                 '192.100.102.0/255.255.255.0',
                 '192.100.103.0/255.255.255.0',
                 '192.197.157.0/255.255.255.0',
                 '193.149.64.0/255.255.224.0',
                 '193.221.113.0/255.255.255.0',
                 '194.69.96.0/255.255.224.0',
                 '194.110.197.0/255.255.255.0',
                 '198.49.8.0/255.255.255.0',
                 '198.105.232.0/255.255.252.0',
                 '198.200.130.0/255.255.255.0',
                 '198.206.164.0/255.255.255.0',
                 '199.30.16.0/255.255.255.0',
                 '199.30.17.0/255.255.255.0',
                 '199.30.18.0/255.255.254.0',
                 '199.30.20.0/255.255.255.0',
                 '199.30.21.0/255.255.255.0',
                 '199.30.22.0/255.255.255.0',
                 '199.30.23.0/255.255.255.0',
                 '199.30.24.0/255.255.254.0',
                 '199.30.26.0/255.255.255.0',
                 '199.30.27.0/255.255.255.128',
                 '199.30.27.144/255.255.255.240',
                 '199.30.27.160/255.255.255.224',
                 '199.30.27.192/255.255.255.192',
                 '199.30.28.0/255.255.255.192',
                 '199.30.28.64/255.255.255.192',
                 '199.30.28.128/255.255.255.128',
                 '199.30.29.0/255.255.255.0',
                 '199.30.30.0/255.255.254.0',
                 '199.60.28.0/255.255.255.0',
                 '199.74.210.0/255.255.255.0',
                 '199.103.90.0/255.255.254.0',
                 '199.103.122.0/255.255.255.0',
                 '199.242.32.0/255.255.240.0',
                 '199.242.48.0/255.255.248.0',
                 '202.89.224.0/255.255.240.0',
                 '204.13.120.0/255.255.248.0',
                 '204.14.180.0/255.255.252.0',
                 '204.79.135.0/255.255.255.0',
                 '204.79.179.0/255.255.255.0',
                 '204.79.181.0/255.255.255.0',
                 '204.79.188.0/255.255.255.0',
                 '204.79.195.0/255.255.255.0',
                 '204.79.196.0/255.255.254.0',
                 '204.79.252.0/255.255.255.0',
                 '204.152.18.0/255.255.254.0',
                 '204.152.140.0/255.255.254.0',
                 '204.231.192.0/255.255.255.0',
                 '204.231.194.0/255.255.254.0',
                 '204.231.197.0/255.255.255.0',
                 '204.231.198.0/255.255.254.0',
                 '204.231.200.0/255.255.248.0',
                 '204.231.208.0/255.255.240.0',
                 '204.231.236.0/255.255.255.0',
                 '205.174.224.0/255.255.240.0',
                 '206.138.168.0/255.255.248.0',
                 '206.191.224.0/255.255.224.0',
                 '207.46.0.0/255.255.0.0',
                 '207.68.174.0/255.255.255.248',
                 '207.68.174.24/255.255.255.248',
                 '207.68.174.32/255.255.255.248',
                 '207.68.174.40/255.255.255.248',
                 '207.68.174.48/255.255.255.248',
                 '207.68.174.56/255.255.255.248',
                 '207.68.174.64/255.255.255.248',
                 '207.68.174.80/255.255.255.240',
                 '207.68.174.96/255.255.255.240',
                 '207.68.174.112/255.255.255.240',
                 '207.68.174.128/255.255.255.248',
                 '207.68.174.136/255.255.255.248',
                 '207.68.174.144/255.255.255.248',
                 '207.68.174.152/255.255.255.248',
                 '207.68.174.160/255.255.255.248',
                 '207.68.174.168/255.255.255.248',
                 '207.68.174.176/255.255.255.248',
                 '207.68.174.184/255.255.255.248',
                 '207.68.174.192/255.255.255.224',
                 '207.68.174.248/255.255.255.248',
                 '208.68.136.0/255.255.248.0',
                 '208.76.44.0/255.255.252.0',
                 '208.84.0.0/255.255.248.0',
                 '209.240.192.0/255.255.224.0',
                 '213.199.128.0/255.255.192.0',
                 '216.32.180.0/255.255.252.0',
                 '216.220.208.0/255.255.240.0']


class Agent(NAE):

    def __init__(self):

        if str(self.params['office365_traffic_bound']) == 'to':
            self.adc = ADCList("office365_to", ADCList.Type.IPV4)
            bound = "dst_ip"
        elif str(self.params['office365_traffic_bound']) == 'from':
            self.adc = ADCList("office365_from", ADCList.Type.IPV4)
            bound = "src_ip"
        else:
            raise Exception("Invalid Parameters, "
                            "please create agent with parameter 'to' or 'from', default: \'to\'")

        for i in range(0, len(IPv4Addresses)):
            entry = ADCEntry(ADCEntry.Type.MATCH)
            getattr(entry, bound)(IPv4Addresses[i])
            j = (i + 1) * 10
            self.adc.add_entry(j, entry)

        if str(self.params['office365_traffic_bound']) == 'to':
            ipv4_traffic = Rate(
                "/rest/v1/system/adc_lists/office365_to/ipv4?attributes=statistics.*", "15s")
        elif str(self.params['office365_traffic_bound']) == 'from':
            ipv4_traffic = Rate(
                "/rest/v1/system/adc_lists/office365_from/ipv4?attributes=statistics.*", "15s")

        ipv4_sum = Sum(ipv4_traffic)
        self.ipv4_monitor = Monitor(
            ipv4_sum, "Ipv4 Traffic "+str(self.params['office365_traffic_bound'])+" Office365")
